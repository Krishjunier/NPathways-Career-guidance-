// backend/utils/pdfGenerator.js
const { jsPDF } = require("jspdf");
const fs = require("fs");
const path = require("path");

/**
 * Generate Career Counselling Portfolio PDF with Solo Leveling theme
 * @param {Object} user - User object from memory (may include user.profile)
 * @param {Object} testResponse - Test response object from memory
 * @returns {Buffer} PDF buffer
 */
const generatePDF = async (user = {}, testResponse = {}) => {
  try {
    const doc = new jsPDF({
      unit: "pt",
      format: "a4",
    });

    // Register custom fonts
    doc.addFont("Exo2-Regular", "Exo2", "normal");
    doc.addFont("Exo2-Bold", "Exo2", "bold");
    doc.addFont("Orbitron-Bold", "Orbitron", "bold");

    // helpers for layout & pagination
    const PAGE_WIDTH = doc.internal.pageSize.width;
    const PAGE_HEIGHT = doc.internal.pageSize.height;
    const MARGIN_LEFT = 40;
    const MARGIN_RIGHT = 40;
    const CONTENT_WIDTH = PAGE_WIDTH - MARGIN_LEFT - MARGIN_RIGHT;
    const LINE_HEIGHT = 14;
    const HEADING_SPACING = 18;
    let y = 40;

    // ensure profile normalization (pull from user.profile or top-level)
    const profile = user.profile || {};

    // convenience nested objects
    const twelfth = (profile.education && profile.education.twelfth) || {};
    const ug = (profile.education && profile.education.ug) || {};
    const pg = (profile.education && profile.education.pg) || {};

    // normalize examScores object -> array (exam, kind, score, percentage)
    const examScoresObj =
      profile.examScores && typeof profile.examScores === "object"
        ? profile.examScores
        : {};
    const examScoresArray = [];

    if (examScoresObj.english) {
      examScoresArray.push({
        exam: examScoresObj.english.exam || "English Proficiency",
        kind: "english",
        score: examScoresObj.english.score ?? "",
        percentage: examScoresObj.english.percentage ?? "",
      });
    }
    if (examScoresObj.aptitude) {
      examScoresArray.push({
        exam: examScoresObj.aptitude.exam || "Aptitude Exam",
        kind: "aptitude",
        score: examScoresObj.aptitude.score ?? "",
        percentage: examScoresObj.aptitude.percentage ?? "",
      });
    }
    // include other exams in examScoresObj
    Object.entries(examScoresObj).forEach(([k, v]) => {
      if (k === "english" || k === "aptitude") return;
      if (v && (v.exam || v.score || v.percentage)) {
        examScoresArray.push({
          exam: v.exam || k,
          kind: k,
          score: v.score ?? "",
          percentage: v.percentage ?? "",
        });
      }
    });

    // normalized fields for compact access
    const normalized = {
      // 12th
      desiredCourse: profile.desiredCourse || user.desiredCourse || "",
      preferredBranch: profile.preferredBranch || user.preferredBranch || "",
      studyCountry: profile.studyCountry || user.studyCountry || "",
      // UG
      bachelorStream: profile.bachelorStream || user.bachelorStream || "",
      ugCourseCategory: profile.ugCourseCategory || user.ugCourseCategory || "",
      ugBranch: profile.ugBranch || user.ugBranch || "",
      targetCountry: profile.targetCountry || user.targetCountry || "",
      department: profile.department || user.department || "",
      collegeName: profile.collegeName || user.collegeName || "",
      completionYear: profile.completionYear || user.completionYear || "",
      // other common fields
      studentType: profile.studentType || user.studentType || "",
      stream: profile.stream || user.stream || "",
      academicPercentile:
        profile.academicPercentile || user.academicPercentile || "",
      ieltsSat: profile.ieltsSat || user.ieltsSat || "",
      careerGoal: profile.careerGoal || user.careerGoal || "",
      experienceYears:
        profile.experienceYears != null
          ? profile.experienceYears
          : user.experienceYears != null
          ? user.experienceYears
          : "",
      researchPapers: profile.researchPapers || user.researchPapers || [],
      skills: profile.skills || user.skills || [],
      projects: profile.projects || user.projects || [],
      examScores: examScoresArray,
      education: {
        twelfth: {
          percentage: twelfth.percentage ?? twelfth.academicPercentile ?? "",
          aptitudeExamType: twelfth.aptitudeExamType || "",
          aptitudeExamScore: twelfth.aptitudeExamScore ?? "",
          aptitudeExamPercentage: twelfth.aptitudeExamPercentage ?? "",
          englishExamType: twelfth.englishExamType || "",
          englishExamScore: twelfth.englishExamScore ?? "",
          englishExamPercentage: twelfth.englishExamPercentage ?? "",
        },
        ug: {
          percentage: ug.percentage ?? "",
          aptitudeExamType: ug.aptitudeExamType || "",
          aptitudeExamScore: ug.aptitudeExamScore ?? "",
          aptitudeExamPercentage: ug.aptitudeExamPercentage ?? "",
          englishExamType: ug.englishExamType || "",
          englishExamScore: ug.englishExamScore ?? "",
          englishExamPercentage: ug.englishExamPercentage ?? "",
        },
        pg: {
          percentage: pg.percentage ?? "",
          aptitudeExamType: pg.aptitudeExamType || "",
          aptitudeExamScore: pg.aptitudeExamScore ?? "",
          aptitudeExamPercentage: pg.aptitudeExamPercentage ?? "",
          englishExamType: pg.englishExamType || "",
          englishExamScore: pg.englishExamScore ?? "",
          englishExamPercentage: pg.englishExamPercentage ?? "",
        },
      },
    };

    // utility: add new page when needed
    function ensureSpace(need = LINE_HEIGHT * 2) {
      if (y + need > PAGE_HEIGHT - 50) {
        doc.addPage();
        y = 40;
      }
    }

    // utility: write heading with Solo Leveling style
    function writeHeading(text) {
      ensureSpace(HEADING_SPACING + LINE_HEIGHT + 10);
      
      // Background rectangle with gradient
      doc.setFillColor(0, 25, 50);
      doc.rect(MARGIN_LEFT - 10, y - 20, PAGE_WIDTH - MARGIN_LEFT - MARGIN_RIGHT + 20, 30, 'F');
      
      // Heading text with Solo Leveling style
      doc.setFont('Orbitron', 'bold');
      doc.setFontSize(16);
      doc.setTextColor(0, 180, 255);
      doc.text(text.toUpperCase(), MARGIN_LEFT, y);
      
      // Decorative line
      doc.setLineWidth(1);
      doc.setDrawColor(0, 180, 255);
      doc.line(MARGIN_LEFT - 10, y + 5, PAGE_WIDTH - MARGIN_RIGHT + 10, y + 5);
      
      y += HEADING_SPACING + 10;
      doc.setFont('Exo2', 'normal');
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
    }

    // utility: write a label + value with wrapping
    function writeKV(label, value) {
      ensureSpace(LINE_HEIGHT * 2);
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      const labelX = MARGIN_LEFT;
      const valueX = MARGIN_LEFT + 140;
      // label
      doc.text(`${label}:`, labelX, y);
      // wrapped value
      const wrapped = doc.splitTextToSize(
        String(value || ""),
        CONTENT_WIDTH - 140
      );
      doc.text(wrapped, valueX, y);
      y += LINE_HEIGHT * (wrapped.length || 1);
    }

    // utility: write bullet list
    function writeBulletedList(items = []) {
      items.forEach((it) => {
        ensureSpace(LINE_HEIGHT);
        const wrapped = doc.splitTextToSize(
          String(it || ""),
          CONTENT_WIDTH - 20
        );
        doc.text(`• ${wrapped[0]}`, MARGIN_LEFT + 10, y);
        if (wrapped.length > 1) {
          for (let i = 1; i < wrapped.length; i++) {
            y += LINE_HEIGHT;
            ensureSpace(LINE_HEIGHT);
            doc.text(wrapped[i], MARGIN_LEFT + 25, y);
          }
        }
        y += LINE_HEIGHT;
      });
    }

    // utility: write a 4-column row (for small table like exam scores)
    // columns widths: c1W, c2W, c3W, c4W
    function writeTableRows4(headerArr = [], rows = []) {
      const c1W = 180;
      const c2W = 110;
      const c3W = 90;
      const c4W = 90;
      const c1X = MARGIN_LEFT;
      const c2X = c1X + c1W + 8;
      const c3X = c2X + c2W + 8;
      const c4X = c3X + c3W + 8;

      // header
      ensureSpace(LINE_HEIGHT * 2);
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      doc.setFont(undefined, "bold");
      const headerWrapped = [
        doc.splitTextToSize(headerArr[0] || "", c1W),
        doc.splitTextToSize(headerArr[1] || "", c2W),
        doc.splitTextToSize(headerArr[2] || "", c3W),
        doc.splitTextToSize(headerArr[3] || "", c4W),
      ];
      const maxHeaderLines = Math.max(...headerWrapped.map((w) => w.length));
      for (let i = 0; i < maxHeaderLines; i++) {
        ensureSpace(LINE_HEIGHT);
        const h1 = headerWrapped[0][i] || "";
        const h2 = headerWrapped[1][i] || "";
        const h3 = headerWrapped[2][i] || "";
        const h4 = headerWrapped[3][i] || "";
        doc.text(h1, c1X, y);
        doc.text(h2, c2X, y);
        doc.text(h3, c3X, y);
        doc.text(h4, c4X, y);
        y += LINE_HEIGHT;
      }
      doc.setFont(undefined, "normal");
      y += 6;

      // rows
      rows.forEach((r) => {
        const c1 = doc.splitTextToSize(String(r[0] || ""), c1W);
        const c2 = doc.splitTextToSize(String(r[1] || ""), c2W);
        const c3 = doc.splitTextToSize(String(r[2] || ""), c3W);
        const c4 = doc.splitTextToSize(String(r[3] || ""), c4W);
        const maxLines = Math.max(c1.length, c2.length, c3.length, c4.length);
        ensureSpace(LINE_HEIGHT * (maxLines + 1));
        for (let i = 0; i < maxLines; i++) {
          const v1 = c1[i] || "";
          const v2 = c2[i] || "";
          const v3 = c3[i] || "";
          const v4 = c4[i] || "";
          doc.text(v1, c1X, y);
          doc.text(v2, c2X, y);
          doc.text(v3, c3X, y);
          doc.text(v4, c4X, y);
          y += LINE_HEIGHT;
        }
        y += 4;
      });
    }

    // --- Header with Solo Leveling style ---
    // Background gradient
    const grd = doc.setFillColor(0, 25, 50);
    doc.rect(0, 0, PAGE_WIDTH, 100, 'F');
    
    // Header text with glow effect
    doc.setFont('Orbitron', 'bold');
    doc.setFontSize(28);
    doc.setTextColor(0, 180, 255);
    doc.text("Career Counselling Portfolio", MARGIN_LEFT, 60);
    
    // Decorative line
    doc.setLineWidth(2);
    doc.setDrawColor(0, 180, 255);
    doc.line(MARGIN_LEFT, 70, PAGE_WIDTH - MARGIN_RIGHT, 70);
    
    doc.setFont('Exo2', 'normal');
    y = 120;

    // --- Personal Information ---
    writeHeading("Personal Information");
    writeKV("Name", user.name || "");
    writeKV("Email", user.email || "");
    writeKV("Phone", user.phone || "");
    writeKV("Status", user.class_status || "");

    // --- Profile / Education Preferences (compact) ---
    writeHeading("Education Preferences");
    writeKV("Student Type", normalized.studentType || "");
    writeKV("Stream", normalized.stream || "");
    writeKV("Desired Course (12th)", normalized.desiredCourse || "");
    writeKV("Preferred Branch (12th)", normalized.preferredBranch || "");
    writeKV("Study Country (12th)", normalized.studyCountry || "");
    writeKV("Bachelor Stream (UG)", normalized.bachelorStream || "");
    writeKV("UG Course Category", normalized.ugCourseCategory || "");
    writeKV("UG Branch", normalized.ugBranch || "");
    writeKV("UG Target Country", normalized.targetCountry || "");
    writeKV("Department / Specialization", normalized.department || "");
    writeKV("College Name", normalized.collegeName || "");
    writeKV("Completion Year", normalized.completionYear || "");
    writeKV("Academic % (12th)", normalized.education.twelfth.percentage || "");
    writeKV("UG % / GPA", normalized.education.ug.percentage || "");
    writeKV("PG % / GPA", normalized.education.pg.percentage || "");
    writeKV("IELTS / SAT", normalized.ieltsSat || "");
    writeKV("Career Goal", normalized.careerGoal || "");
    if (
      normalized.experienceYears !== "" &&
      normalized.experienceYears !== null
    ) {
      writeKV("Experience (yrs)", normalized.experienceYears);
    }

    // --- Exam Scores Section ---
    writeHeading("Exam Scores");
    const examRows = (normalized.examScores || []).map((e) => [
      e.exam || "",
      e.kind || "",
      e.score != null ? String(e.score) : "",
      e.percentage != null ? String(e.percentage) : "",
    ]);
    if (examRows.length) {
      writeTableRows4(["Exam", "Kind", "Score", "Percentage"], examRows);
    } else {
      ensureSpace(LINE_HEIGHT);
      doc.text("No exam scores available.", MARGIN_LEFT + 5, y);
      y += LINE_HEIGHT;
    }

    // --- Skills ---
    if (Array.isArray(normalized.skills) && normalized.skills.length) {
      writeHeading("Skills");
      writeBulletedList(normalized.skills);
    }

    // --- Projects / Papers ---
    if (Array.isArray(normalized.projects) && normalized.projects.length) {
      writeHeading("Projects & Papers");
      normalized.projects.forEach((p, idx) => {
        ensureSpace(LINE_HEIGHT * 2);
        const title = p.title || `Project ${idx + 1}`;
        const lineParts = [title];
        if (p.link) lineParts.push(`Link: ${p.link}`);
        const combined = lineParts.join(" — ");
        const wrapped = doc.splitTextToSize(combined, CONTENT_WIDTH - 10);
        doc.text(wrapped, MARGIN_LEFT + 10, y);
        y += LINE_HEIGHT * (wrapped.length || 1) + 4;
      });
    }

    // --- Test Responses ---
    writeHeading("Assessment / Test Responses");
    if (Array.isArray(testResponse.answers) && testResponse.answers.length) {
      testResponse.answers.forEach((ans, idx) => {
        ensureSpace(LINE_HEIGHT * 2);
        const qText = ans.question || `Question ${ans.questionId || idx + 1}`;
        const aText = ans.answer || "";
        const qWrapped = doc.splitTextToSize(`Q: ${qText}`, CONTENT_WIDTH - 10);
        doc.text(qWrapped, MARGIN_LEFT + 5, y);
        y += LINE_HEIGHT * (qWrapped.length || 1);
        const aWrapped = doc.splitTextToSize(`A: ${aText}`, CONTENT_WIDTH - 30);
        doc.text(aWrapped, MARGIN_LEFT + 20, y);
        y += LINE_HEIGHT * (aWrapped.length || 1) + 4;
      });
    } else if (
      testResponse.answers &&
      typeof testResponse.answers === "object"
    ) {
      Object.entries(testResponse.answers).forEach(([qid, ans]) => {
        ensureSpace(LINE_HEIGHT * 2);
        if (
          ans &&
          typeof ans === "object" &&
          ("question" in ans || "answer" in ans)
        ) {
          const qWrapped = doc.splitTextToSize(
            `Q: ${ans.question || qid}`,
            CONTENT_WIDTH - 10
          );
          doc.text(qWrapped, MARGIN_LEFT + 5, y);
          y += LINE_HEIGHT * (qWrapped.length || 1);
          const aWrapped = doc.splitTextToSize(
            `A: ${ans.answer || ""}`,
            CONTENT_WIDTH - 30
          );
          doc.text(aWrapped, MARGIN_LEFT + 20, y);
          y += LINE_HEIGHT * (aWrapped.length || 1) + 4;
        } else {
          const qWrapped = doc.splitTextToSize(`Q: ${qid}`, CONTENT_WIDTH - 10);
          doc.text(qWrapped, MARGIN_LEFT + 5, y);
          y += LINE_HEIGHT * (qWrapped.length || 1);
          const aWrapped = doc.splitTextToSize(
            `A: ${typeof ans === "string" ? ans : JSON.stringify(ans)}`,
            CONTENT_WIDTH - 30
          );
          doc.text(aWrapped, MARGIN_LEFT + 20, y);
          y += LINE_HEIGHT * (aWrapped.length || 1) + 4;
        }
      });
    } else {
      ensureSpace(LINE_HEIGHT);
      doc.text("No test responses available.", MARGIN_LEFT + 5, y);
      y += LINE_HEIGHT;
    }

    // --- Career Suggestion / Recommendation ---
    const suggestion =
      testResponse?.careerSuggestion ||
      testResponse?.careerRecommendation ||
      {};
    if (
      suggestion &&
      (suggestion.domain ||
        suggestion.description ||
        (suggestion.roles && suggestion.roles.length))
    ) {
      writeHeading("Career Recommendation");
      writeKV("Domain", suggestion.domain || "N/A");
      if (suggestion.description) {
        ensureSpace(LINE_HEIGHT * 3);
        const descWrapped = doc.splitTextToSize(
          suggestion.description,
          CONTENT_WIDTH - 10
        );
        doc.text(descWrapped, MARGIN_LEFT + 5, y);
        y += LINE_HEIGHT * (descWrapped.length || 1);
      }
      if (Array.isArray(suggestion.roles) && suggestion.roles.length) {
        ensureSpace(LINE_HEIGHT * 2);
        doc.text("Suggested Roles:", MARGIN_LEFT + 5, y);
        y += LINE_HEIGHT;
        writeBulletedList(suggestion.roles);
      }
      if (Array.isArray(suggestion.courses) && suggestion.courses.length) {
        ensureSpace(LINE_HEIGHT * 2);
        doc.text("Recommended Courses:", MARGIN_LEFT + 5, y);
        y += LINE_HEIGHT;
        writeBulletedList(suggestion.courses);
      }
    }

    // --- Meta footer (Generated on, App name) ---
    ensureSpace(LINE_HEIGHT * 3);
    doc.setFontSize(10);
    doc.setTextColor(100);
    const generatedDate = new Date().toLocaleString();
    doc.text(`Generated on: ${generatedDate}`, MARGIN_LEFT, PAGE_HEIGHT - 30);
    doc.text(
      "Career Counselling Web App",
      PAGE_WIDTH - MARGIN_RIGHT - 140,
      PAGE_HEIGHT - 30
    );

    const arrayBuffer = doc.output("arraybuffer");
    return Buffer.from(arrayBuffer);
  } catch (error) {
    console.error("PDF Generation Error:", error);
    throw error;
  }
};

module.exports = {
  generatePDF,
};
